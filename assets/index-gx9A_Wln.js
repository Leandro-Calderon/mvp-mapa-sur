const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MapContainer-Dp-V4okk.js","assets/react-vendor-BYBhLt3k.js","assets/react-map-gl-vendor-Cqa43sAg.js","assets/maplibre-Crbi2ECN.js","assets/MapContainer-MGNviBeR.css"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,a,r)=>((t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r)(t,"symbol"!=typeof a?a+"":a,r);import{r as a,a as r,R as s}from"./react-vendor-BYBhLt3k.js";import{_ as i}from"./react-map-gl-vendor-Cqa43sAg.js";var n={exports:{}},o={},l=a,c=Symbol.for("react.element"),d=Symbol.for("react.fragment"),u=Object.prototype.hasOwnProperty,h=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};function g(e,t,a){var r,s={},i=null,n=null;for(r in void 0!==a&&(i=""+a),void 0!==t.key&&(i=""+t.key),void 0!==t.ref&&(n=t.ref),t)u.call(t,r)&&!p.hasOwnProperty(r)&&(s[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===s[r]&&(s[r]=t[r]);return{$$typeof:c,type:e,key:i,ref:n,props:s,_owner:h.current}}o.Fragment=d,o.jsx=g,o.jsxs=g,n.exports=o;var m=n.exports,f={},b=r;f.createRoot=b.createRoot,f.hydrateRoot=b.hydrateRoot;const y=a.createContext(null),x=[-60.66904,-32.93968],S=({children:e,initialState:t})=>{const[r,s]=a.useState({center:t?.center??x,zoom:t?.zoom??12,bearing:t?.bearing??0,pitch:t?.pitch??0}),i=a.useRef(null),n=a.useCallback(e=>{i.current=e},[]),o=a.useCallback(e=>{s(t=>({...t,...e}))},[]),l=a.useMemo(()=>({mapState:r,setMapState:o,mapRef:i,setMapReference:n}),[r,n,o]);return m.jsx(y.Provider,{value:l,children:e})},w=()=>{const e=a.useContext(y);if(!e)throw new Error("useMapContext must be used within a MapProvider");return e},v=({isLoading:e,hasError:t})=>e?m.jsx("div",{className:"_loadingIndicator_1lnxj_1",children:"Cargando capasâ€¦"}):t?m.jsx("div",{className:"_errorIndicator_1lnxj_14",children:"Error al cargar datos geoespaciales. Intenta recargar la pÃ¡gina."}):null,C={debug:(e,t)=>{},info:(e,t)=>{},warn:(e,t)=>{},error:(e,t)=>{}},E=({searchQuery:e,searchType:t,appliedQuery:r,appliedType:s,onQueryChange:i,onTypeChange:n,onSubmit:o,onClear:l,onShowAllToggle:c,showAllLayers:d,buildingResults:u,streetResults:h,searchResults:p,collapsed:g,onToggleCollapse:f})=>{const b=a.useRef(null),y=e.trim(),x=r.trim(),S=x?`Buscando ${s??t}: ${x}`:y?`Preparar ${t}: ${e}`:{edificio:"Buscar edificio...",departamento:"Buscar departamento...",calle:"Buscar calle...",plan:"Buscar plan..."}[t],w=e=>{e!==t&&n(e)},v=["search-panel",g?"collapsed":"",y||x?"":"idle"].filter(Boolean).join(" ");return m.jsxs("div",{className:v,children:[m.jsxs("div",{className:"search-header",onClick:()=>{f(!g)},children:[m.jsx("div",{className:"search-icon",children:m.jsx("span",{className:"search-icon-graphic",children:"ðŸ”"})}),m.jsx("div",{className:"search-input-preview",children:S}),m.jsx("div",{className:"collapse-icon",children:"â–¼"})]}),m.jsxs("div",{className:"search-content",children:[x&&m.jsxs("div",{className:"search-indicator active",children:[m.jsx("span",{children:"âœ“"}),m.jsx("span",{children:1===p?"1 resultado encontrado":`${p} resultados encontrados`})]}),x&&0===p&&m.jsx("div",{className:"search-feedback warning",children:"No encontramos coincidencias para tu bÃºsqueda. Revisa los datos ingresados."}),m.jsxs("div",{className:"search-type-row",children:[m.jsx("button",{className:"type-btn type-btn-row "+("edificio"===t?"active":""),onClick:()=>w("edificio"),children:"ðŸ¢ Edificio"}),m.jsx("button",{className:"type-btn type-btn-row "+("departamento"===t?"active":""),onClick:()=>w("departamento"),children:"ðŸšª Departamento"})]}),m.jsxs("div",{className:"search-type-row",children:[m.jsx("button",{className:"type-btn type-btn-row "+("calle"===t?"active":""),onClick:()=>w("calle"),children:"ðŸ›£ï¸ Calle"}),m.jsx("button",{className:"type-btn type-btn-row "+("plan"===t?"active":""),onClick:()=>w("plan"),children:"ðŸ“‹ Plan"})]}),m.jsxs("div",{className:"search-input-row",children:[m.jsxs("div",{className:"search-input-group",children:[m.jsx("input",{ref:b,type:"text",className:"search-input",placeholder:{edificio:"Ej: 86, D, 22 ",departamento:"Ej: 543, 204, 15...",calle:"Ej: Publica P, Pasaje 2...",plan:"Ej: 077, 123..."}[t],value:e,onChange:e=>{i(e.target.value)},onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),b.current?.blur(),o())}}),(e||x)&&m.jsx("button",{className:"clear-btn",onClick:()=>{l()},children:"Ã—"})]}),m.jsxs("button",{className:"layer-btn layer-btn-row "+(d?"active":""),onClick:()=>{b.current?.blur(),f(!0),c()},children:[m.jsx("span",{className:"layer-icon",children:"ðŸ‘ï¸"}),m.jsx("span",{children:"Ver Todo"})]})]})]})]})},j=({isOpen:e,onClose:t})=>{if(!e)return null;const a=/Android/i.test(navigator.userAgent),r=/iPhone|iPad|iPod/i.test(navigator.userAgent);return m.jsx("div",{className:"gps-modal-overlay",onClick:t,children:m.jsxs("div",{className:"gps-modal-content",onClick:e=>e.stopPropagation(),children:[m.jsxs("div",{className:"gps-modal-header",children:[m.jsx("div",{className:"gps-icon",children:"ðŸ“"}),m.jsx("h2",{children:"GPS Desactivado"})]}),m.jsxs("div",{className:"gps-modal-body",children:[m.jsx("p",{className:"gps-message",children:"Para obtener tu ubicaciÃ³n actual y mostrar los puntos de interÃ©s cercanos, necesitas activar el GPS en tu dispositivo."}),a?m.jsxs("div",{className:"instructions",children:[m.jsx("p",{children:"Para activar el GPS en tu dispositivo Android:"}),m.jsxs("ol",{children:[m.jsxs("li",{children:["Ve a ",m.jsx("strong",{children:"ConfiguraciÃ³n"})," de tu dispositivo"]}),m.jsxs("li",{children:["Busca y selecciona ",m.jsx("strong",{children:"UbicaciÃ³n"})]}),m.jsxs("li",{children:["Activa la opciÃ³n ",m.jsx("strong",{children:"Usar ubicaciÃ³n"})]}),m.jsx("li",{children:"Vuelve a la aplicaciÃ³n y presiona el botÃ³n de ubicaciÃ³n nuevamente"})]})]}):r?m.jsxs("div",{className:"instructions",children:[m.jsx("p",{children:"Para activar el GPS en tu dispositivo iOS:"}),m.jsxs("ol",{children:[m.jsxs("li",{children:["Ve a ",m.jsx("strong",{children:"ConfiguraciÃ³n"})]}),m.jsxs("li",{children:["Selecciona ",m.jsx("strong",{children:"Privacidad y seguridad"})]}),m.jsxs("li",{children:["Selecciona ",m.jsx("strong",{children:"UbicaciÃ³n"})]}),m.jsx("li",{children:"AsegÃºrate de que la ubicaciÃ³n estÃ© activa"}),m.jsx("li",{children:"Busca esta aplicaciÃ³n en la lista y permite el acceso"}),m.jsx("li",{children:"Vuelve a la aplicaciÃ³n y presiona el botÃ³n de ubicaciÃ³n nuevamente"})]})]}):m.jsxs("div",{className:"instructions",children:[m.jsx("p",{children:"Para activar el GPS en tu navegador:"}),m.jsxs("ol",{children:[m.jsx("li",{children:"Busca el Ã­cono de ubicaciÃ³n o candado en la barra de direcciones"}),m.jsxs("li",{children:["Haz clic en Ã©l y selecciona ",m.jsx("strong",{children:"Permitir"})," o ",m.jsx("strong",{children:"Solicitar acceso"})]}),m.jsx("li",{children:"Si no aparece, verifica la configuraciÃ³n de privacidad de tu navegador"}),m.jsx("li",{children:"Recarga la pÃ¡gina y presiona el botÃ³n de ubicaciÃ³n nuevamente"})]})]}),m.jsx("div",{className:"gps-modal-footer",children:m.jsx("button",{className:"gps-modal-button primary",onClick:t,children:"Entendido"})})]})]})})},N=({onToggle:e,isActive:t=!1,isTracking:r=!1,hasError:s=!1,errorMessage:i=null})=>{const[n,o]=a.useState(t),[l,c]=a.useState(!1);a.useEffect(()=>{o(t)},[t]);const d=()=>{c(!0)},u=()=>{navigator.geolocation.getCurrentPosition(t=>{o(!0),e(!0)},t=>{if(C.error("Error after OS permission prompt",t),C.error("Error details",{code:t.code,message:t.message}),t.code===t.PERMISSION_DENIED)if(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){const e=/Android/i.test(navigator.userAgent),t=/iPhone|iPad|iPod/i.test(navigator.userAgent);e?alert("Para activar el GPS, ve a ConfiguraciÃ³n > UbicaciÃ³n y activa la ubicaciÃ³n para esta aplicaciÃ³n."):t&&alert("Para activar el GPS, ve a ConfiguraciÃ³n > Privacidad > UbicaciÃ³n y activa la ubicaciÃ³n para esta aplicaciÃ³n.")}else alert("Por favor, habilita el GPS en la configuraciÃ³n de tu navegador y recarga la pÃ¡gina.");else t.code===t.POSITION_UNAVAILABLE?alert("No se pudo obtener tu ubicaciÃ³n. AsegÃºrate de que el GPS estÃ© activado y tienes buena seÃ±al."):t.code===t.TIMEOUT&&alert("No se pudo obtener tu ubicaciÃ³n. Intenta de nuevo.");o(!1),e(!1)},{timeout:1e4,enableHighAccuracy:!0,maximumAge:0})},h=["location-btn",n?"active":"idle",r&&!n?"loading":"",s?"error":""].filter(Boolean).join(" ");return m.jsxs(m.Fragment,{children:[m.jsx("button",{className:h,onClick:()=>{if(!n)return void(navigator.geolocation?"permissions"in navigator?navigator.permissions.query({name:"geolocation"}).then(e=>{C.debug("Current permission status",{state:e.state}),"denied"!==e.state?navigator.geolocation.getCurrentPosition(()=>{u()},e=>{C.error("GPS status check error",e),e.code===e.POSITION_UNAVAILABLE?d():u()},{timeout:2e3,enableHighAccuracy:!1,maximumAge:0}):d()}).catch(e=>{C.error("Error checking permission status",e),u()}):u():(C.error("Geolocation not supported"),alert("La geolocalizaciÃ³n no es compatible con tu navegador.")));const t=!n;o(t),e(t)},"aria-label":s?i||"Error de ubicaciÃ³n":n?"Desactivar ubicaciÃ³n":"Activar ubicaciÃ³n",title:s?i||"Error al obtener la ubicaciÃ³n. Haz clic para intentar habilitar GPS":n?"Desactivar seguimiento de ubicaciÃ³n":"Activar seguimiento de ubicaciÃ³n",children:m.jsx("div",{className:"location-icon",children:"ðŸ“"})}),m.jsx(j,{isOpen:l,onClose:()=>{c(!1)}})]})},A=({searchQuery:e,searchType:t,appliedQuery:a,appliedType:r,onQueryChange:s,onTypeChange:i,onSubmit:n,onClear:o,onShowAllToggle:l,showAllLayers:c,buildingResults:d,streetResults:u,searchResults:h,panelCollapsed:p,onToggleCollapse:g,locationActive:f,onLocationToggle:b,isLocationTracking:y,locationError:x})=>m.jsxs(m.Fragment,{children:[m.jsx(E,{searchQuery:e,searchType:t,appliedQuery:a,appliedType:r,onQueryChange:s,onTypeChange:i,onSubmit:n,onClear:o,onShowAllToggle:l,showAllLayers:c,buildingResults:d,streetResults:u,searchResults:h,collapsed:p,onToggleCollapse:g}),m.jsx(N,{onToggle:b,isActive:f,isTracking:y,hasError:!!x,errorMessage:x})]}),T=new class{constructor(){t(this,"listeners",new Set),t(this,"currentStatus",{isOnline:navigator.onLine}),this.initialize()}initialize(){window.addEventListener("online",this.handleConnectionChange.bind(this)),window.addEventListener("offline",this.handleConnectionChange.bind(this)),"connection"in navigator&&navigator.connection.addEventListener("change",this.handleConnectionChange.bind(this)),this.updateConnectionStatus()}handleConnectionChange(){this.updateConnectionStatus(),this.notifyListeners()}updateConnectionStatus(){if(this.currentStatus={isOnline:navigator.onLine},"connection"in navigator){const e=navigator.connection;this.currentStatus={...this.currentStatus,effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt,saveData:e.saveData}}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.currentStatus)}catch(e){}})}getConnectionStatus(){return{...this.currentStatus}}isOnline(){return this.currentStatus.isOnline}addListener(e){this.listeners.add(e);try{e(this.currentStatus)}catch(e){}return()=>{this.listeners.delete(e)}}removeListener(e){this.listeners.delete(e)}async waitForConnection(e=3e4){return!!this.isOnline()||new Promise(t=>{let a,r=null;const s=()=>{a&&clearTimeout(a),r&&r()};a=setTimeout(()=>{s(),t(!1)},e),r=this.addListener(e=>{e.isOnline&&(s(),t(!0))})})}getNetworkQuality(){if(!this.isOnline())return"unknown";const e=navigator.connection;if(!e)return"unknown";const{effectiveType:t,downlink:a}=e;return"slow-2g"===t||"2g"===t||a<.1?"slow":"3g"===t||a<1?"medium":"4g"===t||a>=1?"fast":"unknown"}shouldUseOfflineFirst(){const e=this.getNetworkQuality();return!this.isOnline()||"slow"===e}},R=({showCacheInfo:e=!1,cacheInfo:t})=>{const{isOnline:r,isOffline:s,networkQuality:i,effectiveType:n}=(()=>{const[e,t]=a.useState(T.getConnectionStatus());return a.useEffect(()=>T.addListener(t),[]),{...e,isOnline:e.isOnline,isOffline:!e.isOnline,networkQuality:T.getNetworkQuality(),shouldUseOfflineFirst:T.shouldUseOfflineFirst()}})(),[o,l]=a.useState(!0),[c,d]=a.useState(!1),[u,h]=a.useState(()=>navigator.onLine),[p,g]=a.useState(!1);return a.useEffect(()=>{const e=setTimeout(()=>{l(!1),d(!0)},3e3);return()=>clearTimeout(e)},[]),a.useEffect(()=>{if(c&&u!==r&&!p){l(!0),h(r),g(!0);const e=setTimeout(()=>{l(!1),g(!1)},3e3);return()=>{clearTimeout(e),g(!1)}}},[r,u,c,p]),o?m.jsxs("div",{className:"connection-status "+(s?"offline":"online"),children:[m.jsxs("div",{className:"connection-indicator",children:[m.jsx("span",{className:"connection-icon",children:(()=>{if(s)return"ðŸ“´";switch(i){case"fast":return"ðŸš€";case"medium":return"ðŸ“¶";case"slow":return"ðŸŒ";default:return"â“"}})()}),m.jsx("span",{className:"connection-text",children:(()=>{if(s)return"Sin conexiÃ³n";switch(i){case"fast":return"ConexiÃ³n rÃ¡pida";case"medium":return"ConexiÃ³n media";case"slow":return"ConexiÃ³n lenta";default:return"Calidad desconocida"}})()}),n&&m.jsxs("span",{className:"connection-type",children:["(",n,")"]})]}),e&&t&&m.jsxs("div",{className:"cache-info",children:[m.jsxs("div",{className:"cache-status",children:[m.jsxs("span",{className:"cache-indicator "+(t.buildings?"cached":"not-cached"),children:["ðŸ¢ Edificios: ",t.buildings?"âœ…":"âŒ"]}),m.jsxs("span",{className:"cache-indicator "+(t.streets?"cached":"not-cached"),children:["ðŸ›£ï¸ Calles: ",t.streets?"âœ…":"âŒ"]})]}),t.lastSync&&m.jsxs("div",{className:"last-sync",children:["Ãšltima sincronizaciÃ³n: ",(e=>{if(!e)return"Nunca";const t=Date.now()-e,a=Math.floor(t/6e4),r=Math.floor(a/60),s=Math.floor(r/24);return s>0?`Hace ${s} dÃ­a${s>1?"s":""}`:r>0?`Hace ${r} hora${r>1?"s":""}`:a>0?`Hace ${a} minuto${a>1?"s":""}`:"Ahora mismo"})(t.lastSync)]})]})]}):null},k=({buildings:e,streets:t,onRefresh:a})=>{if(e.loading||t.loading)return null;if(!(e.error||t.error||e.isStale||t.isStale))return null;const r=e.isStale||t.isStale,s=e.fromCache||t.fromCache,i=e.error||t.error?{type:"error",icon:"âŒ",text:"Error al cargar datos",subtext:"Verifica tu conexiÃ³n e intenta nuevamente"}:r&&s?{type:"warning",icon:"âš ï¸",text:"Datos desactualizados",subtext:"Mostrando datos en cachÃ©. ConÃ©ctate a internet para actualizar."}:s?{type:"info",icon:"ðŸ’¾",text:"Modo offline",subtext:"Usando datos guardados localmente"}:null;return i?m.jsx("div",{className:`data-status-notification ${i.type}`,children:m.jsxs("div",{className:"notification-content",children:[m.jsx("span",{className:"notification-icon",children:i.icon}),m.jsxs("div",{className:"notification-text",children:[m.jsx("div",{className:"notification-title",children:i.text}),i.subtext&&m.jsx("div",{className:"notification-subtitle",children:i.subtext})]}),a&&m.jsx("button",{className:"refresh-button",onClick:a,disabled:e.loading||t.loading,children:"ðŸ”„ Actualizar"})]})}):null},_=e=>{switch(e){case"Bloque":return"#FF6B6B";case"Torre":return"#4ECDC4";case"Departamento":return"#45B7D1";default:return"#95A5A6"}},P=({isVisible:e,onClose:t})=>e?m.jsxs("div",{style:{position:"absolute",bottom:"20px",left:"20px",backgroundColor:"white",padding:"12px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.2)",zIndex:1e3,fontSize:"12px",minWidth:"150px"},children:[m.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[m.jsx("strong",{style:{fontSize:"14px"},children:"Tipos FONAVI"}),m.jsx("button",{onClick:t,style:{background:"none",border:"none",fontSize:"16px",cursor:"pointer",padding:"0",width:"20px",height:"20px"},children:"Ã—"})]}),["Bloque","Torre","Departamento"].map(e=>m.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:"6px"},children:[m.jsx("div",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:_(e),marginRight:"8px",border:"2px solid white",boxShadow:"0 1px 3px rgba(0,0,0,0.3)"}}),m.jsx("span",{children:e})]},e))]}):null;async function O(e,t,a,r,s,i){try{if(s(e=>({...e,loading:!0,error:null})),e.hasMetadata){const o=await e.loadWithMetadata({forceRefresh:t,preferOffline:a&&!t});s({data:o.data,loading:!1,error:null,fromCache:o.fromCache,isStale:o.isStale,lastUpdated:o.lastUpdated}),r&&o.isStale&&!t&&i&&(n=i,"requestIdleCallback"in window?window.requestIdleCallback(()=>n(),{timeout:2e3}):setTimeout(n,1e3))}else s({data:await e.loadBasic(),loading:!1,error:null,fromCache:!1,isStale:!1})}catch(e){s({data:[],loading:!1,error:e instanceof Error?e:new Error("Unknown error"),fromCache:!1,isStale:!1})}var n}const L=e=>{const[t,r]=a.useState({data:[],loading:!0,error:null,fromCache:!1,isStale:!1}),[s,i]=a.useState({data:[],loading:!0,error:null,fromCache:!1,isStale:!1}),n=a.useRef(!1),o=a.useCallback(async(t=!1)=>{const a=T.isOnline(),s=T.shouldUseOfflineFirst(),l="loadBuildingsWithMetadata"in e,c="loadStreetsWithMetadata"in e,d=()=>{n.current||(n.current=!0,o(!0).finally(()=>{n.current=!1}))};await Promise.all([O({loadWithMetadata:t=>e.loadBuildingsWithMetadata(t),loadBasic:()=>e.loadBuildings(),hasMetadata:l},t,s,a,r,d),O({loadWithMetadata:t=>e.loadStreetsWithMetadata(t),loadBasic:()=>e.loadStreets(),hasMetadata:c},t,s,a,i,d)])},[e]);return a.useEffect(()=>{let e=!0;return(async()=>{e&&await o()})(),()=>{e=!1}},[o]),a.useEffect(()=>T.addListener(async e=>{e.isOnline&&await o(!0)}),[o]),{buildings:t,streets:s,refresh:a.useCallback(()=>{o(!0)},[o]),isOnline:T.isOnline(),networkQuality:T.getNetworkQuality()}},M=new class{constructor(){t(this,"DB_NAME","MapaSurDB"),t(this,"DB_VERSION",1),t(this,"STORE_NAME","geojson_cache"),t(this,"SYNC_STORE_NAME","sync_status"),t(this,"db",null)}async init(){return new Promise((e,t)=>{const a=indexedDB.open(this.DB_NAME,this.DB_VERSION);a.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${a.error?.message}`))},a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.STORE_NAME)){const e=t.createObjectStore(this.STORE_NAME,{keyPath:"id"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("version","version",{unique:!1})}t.objectStoreNames.contains(this.SYNC_STORE_NAME)||t.createObjectStore(this.SYNC_STORE_NAME,{keyPath:"id"}).createIndex("lastSync","lastSync",{unique:!1})}})}async saveData(e,t,a="1.0.0",r){this.db||await this.init();const s={id:e,data:t,timestamp:Date.now(),version:a,etag:r};return new Promise((e,t)=>{const a=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).put(s);a.onerror=()=>{t(new Error(`Failed to save data: ${a.error?.message}`))},a.onsuccess=()=>{e()}})}async getData(e){return this.db||await this.init(),new Promise((t,a)=>{const r=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).get(e);r.onerror=()=>{a(new Error(`Failed to get data: ${r.error?.message}`))},r.onsuccess=()=>{t(r.result||null)}})}async getAllCachedIds(){return this.db||await this.init(),new Promise((e,t)=>{const a=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).getAllKeys();a.onerror=()=>{t(new Error(`Failed to get all keys: ${a.error?.message}`))},a.onsuccess=()=>{e(a.result)}})}async isDataFresh(e,t=864e5){try{const a=await this.getData(e);return!!a&&Date.now()-a.timestamp<t}catch{return!1}}async saveSyncStatus(e){this.db||await this.init();const t={id:"main",...e};return new Promise((e,a)=>{const r=this.db.transaction([this.SYNC_STORE_NAME],"readwrite").objectStore(this.SYNC_STORE_NAME).put(t);r.onerror=()=>{a(new Error(`Failed to save sync status: ${r.error?.message}`))},r.onsuccess=()=>{e()}})}async getSyncStatus(){return this.db||await this.init(),new Promise((e,t)=>{const a=this.db.transaction([this.SYNC_STORE_NAME],"readonly").objectStore(this.SYNC_STORE_NAME).get("main");a.onerror=()=>{t(new Error(`Failed to get sync status: ${a.error?.message}`))},a.onsuccess=()=>{e(a.result||null)}})}async clearCache(){return this.db||await this.init(),new Promise((e,t)=>{const a=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).clear();a.onerror=()=>{t(new Error(`Failed to clear cache: ${a.error?.message}`))},a.onsuccess=()=>{e()}})}async getCacheSize(){return this.db||await this.init(),new Promise((e,t)=>{const a=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME);let r=0;const s=a.openCursor();s.onerror=()=>{t(new Error(`Failed to calculate cache size: ${s.error?.message}`))},s.onsuccess=t=>{const a=t.target.result;a?(r+=JSON.stringify(a.value).length,a.continue()):e(r)}})}};class I{constructor(){t(this,"buildingsPath","assets/fonavi.geojson"),t(this,"streetsPath","assets/calles.geojson"),t(this,"BUILDINGS_CACHE_KEY","buildings"),t(this,"STREETS_CACHE_KEY","streets"),t(this,"DEFAULT_MAX_CACHE_AGE",864e5)}buildResourceUrl(e){return`/mvp-mapa-sur/${e}`}async fetchWithCache(e,t,a={}){const{maxCacheAge:r=this.DEFAULT_MAX_CACHE_AGE,forceRefresh:s=!1,preferOffline:i=!1}=a,n=T.isOnline(),o=i||T.shouldUseOfflineFirst();try{const a=await M.getData(e),i=null!==a,l=i&&Date.now()-a.timestamp<r;if(o&&i&&!s)return{data:a.data,fromCache:!0,isStale:!l,lastUpdated:a.timestamp};if(n&&(s||!i||!l))try{const a=await this.fetchFromNetwork(t);return await M.saveData(e,a,"1.0.0",(new Date).toISOString()),{data:a,fromCache:!1,isStale:!1,lastUpdated:Date.now()}}catch(t){if(C.warn(`Network request failed for ${e}`,t),i)return{data:a.data,fromCache:!0,isStale:!0,lastUpdated:a.timestamp};throw t}if(i)return{data:a.data,fromCache:!0,isStale:!l,lastUpdated:a.timestamp};throw new Error(`No cached data available for ${e} and device is offline`)}catch(t){throw C.error(`Error in fetchWithCache for ${e}`,t),t}}async fetchFromNetwork(e){const t=await fetch(e,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!t.ok)throw new Error(`Failed to fetch ${e}: ${t.status} ${t.statusText}`);const a=await t.json();if(Array.isArray(a))return a;if(a.features&&Array.isArray(a.features))return a.features;throw new Error(`Invalid data format from ${e}`)}async loadBuildings(e={}){try{const t=this.buildResourceUrl(this.buildingsPath),a=await this.fetchWithCache(this.BUILDINGS_CACHE_KEY,t,e);return C.debug(`Buildings loaded from: ${a.fromCache?"cache":"network"}${a.isStale?" (stale)":""}`),a.data}catch(e){throw new Error(`Failed to load buildings data: ${e instanceof Error?e.message:"Unknown error"}`)}}async loadStreets(e={}){try{const t=this.buildResourceUrl(this.streetsPath),a=await this.fetchWithCache(this.STREETS_CACHE_KEY,t,e);return C.debug(`Streets loaded from: ${a.fromCache?"cache":"network"}${a.isStale?" (stale)":""}`),a.data}catch(e){throw new Error(`Failed to load streets data: ${e instanceof Error?e.message:"Unknown error"}`)}}async loadBuildingsWithMetadata(e={}){try{const t=this.buildResourceUrl(this.buildingsPath);return await this.fetchWithCache(this.BUILDINGS_CACHE_KEY,t,e)}catch(e){throw new Error(`Failed to load buildings data: ${e instanceof Error?e.message:"Unknown error"}`)}}async loadStreetsWithMetadata(e={}){try{const t=this.buildResourceUrl(this.streetsPath);return await this.fetchWithCache(this.STREETS_CACHE_KEY,t,e)}catch(e){throw new Error(`Failed to load streets data: ${e instanceof Error?e.message:"Unknown error"}`)}}async clearCache(){await M.clearCache()}async getCacheInfo(){const[e,t,a]=await Promise.all([M.getData(this.BUILDINGS_CACHE_KEY),M.getData(this.STREETS_CACHE_KEY),M.getCacheSize()]);return{buildings:e,streets:t,totalSize:a}}async refreshCache(){const e={forceRefresh:!0,maxCacheAge:0};await Promise.all([this.loadBuildings(e),this.loadStreets(e)])}async isDataAvailableOffline(){const[e,t]=await Promise.all([M.isDataFresh(this.BUILDINGS_CACHE_KEY),M.isDataFresh(this.STREETS_CACHE_KEY)]);return{buildings:e,streets:t}}}const D=()=>new I,B=D(),U=D(),$=(e,t)=>{if(null===e||!t.trim())return!1;const a=t.trim().toLowerCase();return e.toString().toLowerCase()===a},F=e=>e.replace(/^0+/,"")||"0",W=["Torre","Bloque"],z={enableHighAccuracy:!0,maximumAge:1e3,timeout:1e4},G=e=>((e,t=100)=>"string"!=typeof e?"":e.trim().replace(/[<>"'&]/g,"").slice(0,t))(e,50),Q=()=>{const[e,t]=a.useState(""),[r,s]=a.useState("edificio"),[i,n]=a.useState(""),[o,l]=a.useState(null),[c,d]=a.useState(!0),[u,h]=a.useState(!1),[p,g]=a.useState(!1),[m,f]=a.useState(!1),[b,y]=a.useState(0),[x,S]=a.useState(!1),{position:w,accuracy:v,error:E,isActive:j,startTracking:N,stopTracking:A}=(()=>{const[e,t]=a.useState(null),[r,s]=a.useState(null),[i,n]=a.useState(null),[o,l]=a.useState(!1),[c,d]=a.useState(null),u=a.useCallback(e=>{const{latitude:a,longitude:r,accuracy:i}=e.coords;t([r,a]),s(i),n(null)},[]),h=a.useCallback(e=>{switch(C.error("Geolocation error",e),C.error("Error code",{code:e.code}),C.error("Error message",{message:e.message}),e.code){case e.PERMISSION_DENIED:C.error("GPS permission denied by user");break;case e.POSITION_UNAVAILABLE:C.error("GPS position unavailable (possibly turned off)");break;case e.TIMEOUT:C.error("GPS request timed out")}n(e.message),t(null)},[]),p=a.useCallback(async()=>{if(!navigator.geolocation)return C.error("Geolocation not supported"),void n("Geolocation is not supported by your browser");if("permissions"in navigator)try{const e=await navigator.permissions.query({name:"geolocation"});if(C.debug("Current permission state",{state:e.state}),"denied"===e.state)return C.error("Location permission previously denied"),void n("Location permission was denied. Please enable location in your browser settings.");"prompt"===e.state&&C.debug("Will prompt user for location permission")}catch(e){C.error("Error checking permission status",e)}const e=navigator.geolocation.watchPosition(u,h,z);d(e),l(!0)},[u,h]),g=a.useCallback(()=>{c&&(navigator.geolocation.clearWatch(c),d(null),t(null),l(!1))},[c]);return a.useEffect(()=>()=>{c&&navigator.geolocation.clearWatch(c)},[c]),{position:e,accuracy:r,error:i,isActive:o,startTracking:p,stopTracking:g}})(),{data:T,loading:R,error:k}=(()=>{const{buildings:e}=L(B);return e})(),{data:_,loading:P,error:O}=(()=>{const{streets:e}=L(U);return e})(),M=G(e),I=G(i),D=a.useMemo(()=>({edificio:"edificio"===o?I:"",vivienda:"departamento"===o?I:"",plan:"plan"===o?I:""}),[I,o]),Q=a.useMemo(()=>({streetName:"calle"===o?I:""}),[I,o]),H=((e,t)=>{const r=a.useCallback(e=>{const a=t.edificio?.trim()||"",r=t.vivienda?.trim()||"",s=t.plan?.trim()||"";if(!a&&!r&&!s)return!0;const i=!a||W.includes(e.properties.tipo)&&$(e.properties.nombre,a),n=!r||"Departamento"===e.properties.tipo&&$(e.properties.nombre,r),o=!s||((e,t)=>{if(!e||!t.trim())return!1;const a=F(t.trim());return F(e)===a})(e.properties.plan,s);return i&&n&&o},[t.edificio,t.vivienda,t.plan]);return a.useMemo(()=>Array.isArray(e)?e.filter(r):[],[e,r])})(T,D),Y=((e,t)=>{const r=a.useCallback(e=>!t.streetName||((e,t)=>{if(!e||!t.trim())return!1;const a=t.trim().toLowerCase(),r=e.toLowerCase();return!(a.replace(/[\s.]/g,"").length<3)&&(/^\d+$/.test(a)?new RegExp(`\\b${a}\\b`).test(r):r.includes(a))})(e.properties.nombre,t.streetName),[t]);return a.useMemo(()=>Array.isArray(e)?e.filter(r):[],[e,r])})(_,Q),V=m?T:I&&"calle"!==o?H:[],q=m?_:I&&"calle"===o?Y:[],K=V.length,X=q.length,J=K+X,Z=u&&K>0,ee=p&&X>0,te=a.useCallback(e=>{t(e)},[]),ae=a.useCallback(e=>{i&&e!==r&&(n(""),l(null),y(e=>e+1)),e!==r&&t(""),s(e)},[r,i,o]),re=a.useCallback(()=>{const e=M;if(!e)return n(""),void l(null);f(!1),n(e),l(r),y(e=>e+1),t("")},[M,r]),se=a.useCallback(()=>{t(""),n(""),l(null),h(!1),g(!1),y(e=>e+1)},[]),ie=a.useCallback(e=>{if("calles"!==e)0!==K&&h(e=>!e);else{if(0===X)return;g(e=>!e)}},[K,X]),ne=a.useCallback(()=>{f(e=>!e)},[m]),oe=a.useCallback(e=>{e?N():A()},[N,A]),le=a.useCallback(e=>{d(e)},[]);return a.useEffect(()=>I&&o?"calle"===o?(h(!1),void g(X>0)):(g(!1),void h(K>0)):(h(!1),void g(!1)),[b,I,o,K,X]),a.useEffect(()=>{I&&o&&J>0&&d(!0)},[b,I,o,J]),{searchQuery:e,searchType:r,appliedQuery:i,appliedType:o,appliedRevision:b,panelCollapsed:c,showBuildings:u,showStreets:p,showAllLayers:m,locationActive:x,userPosition:w,locationAccuracy:v,locationError:E,isLocationTracking:j,buildingFeatures:T,streetFeatures:_,filteredBuildings:V,filteredStreets:q,buildingResults:K,streetResults:X,totalResults:J,shouldShowBuildings:Z,shouldShowStreets:ee,buildingsLoading:R,streetsLoading:P,buildingsError:k,streetsError:O,handleQueryChange:te,handleTypeChange:ae,handleSubmit:re,handleClear:se,handleLayerToggle:ie,handleShowAllToggle:ne,handleLocationToggle:oe,handlePanelToggle:le}},H=a.lazy(()=>i(()=>import("./MapContainer-Dp-V4okk.js"),__vite__mapDeps([0,1,2,3,4])).then(e=>({default:e.MapContainer}))),Y=()=>m.jsxs("div",{style:{height:"100%",width:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",backgroundColor:"#f0f0f0",color:"#666"},children:[m.jsx("div",{style:{width:"48px",height:"48px",border:"4px solid #e0e0e0",borderTopColor:"#4ECDC4",borderRadius:"50%",animation:"spin 1s linear infinite"}}),m.jsx("p",{style:{marginTop:"16px",fontSize:"14px"},children:"Cargando mapa..."}),m.jsx("style",{children:"\n            @keyframes spin {\n                to { transform: rotate(360deg); }\n            }\n        "})]}),V=()=>{const[e]=a.useState(()=>D()),[t,r]=a.useState({buildings:!1,streets:!1}),[s,i]=a.useState(!0),{buildings:n,streets:o,refresh:l}=L(e);a.useEffect(()=>{(async()=>{try{const t=await e.getCacheInfo();r({buildings:!!t.buildings,streets:!!t.streets,lastSync:Math.max(t.buildings?.timestamp||0,t.streets?.timestamp||0)})}catch(e){C.error("Error getting cache info:",e)}})()},[n.data,o.data,e]);const{searchQuery:c,searchType:d,appliedQuery:u,appliedType:h,appliedRevision:p,panelCollapsed:g,showAllLayers:f,locationActive:b,userPosition:y,locationAccuracy:x,locationError:S,isLocationTracking:w,filteredBuildings:E,filteredStreets:j,buildingResults:N,streetResults:T,totalResults:_,buildingsLoading:O,streetsLoading:M,buildingsError:I,streetsError:B,handleQueryChange:U,handleTypeChange:$,handleSubmit:F,handleClear:W,handleShowAllToggle:z,handleLocationToggle:G,handlePanelToggle:V}=Q(),q=I||B,K=O||M,X=a.useCallback(()=>{const e=document.activeElement,t=e?.classList.contains("search-input");t||g||V(!0)},[g,V]);return m.jsxs("div",{className:"_mapContainer_79siu_1",style:{height:"100vh",width:"100%"},children:[m.jsx(a.Suspense,{fallback:m.jsx(Y,{}),children:m.jsx(H,{filteredBuildings:E,filteredStreets:j,showAllLayers:f,userPosition:y,locationAccuracy:x,locationError:S,isLocationTracking:w,searchRevision:p,onMapClick:X})}),m.jsx(v,{isLoading:K,hasError:!!q}),m.jsx(A,{searchQuery:c,searchType:d,appliedQuery:u,appliedType:h,onQueryChange:U,onTypeChange:$,onSubmit:F,onClear:W,onShowAllToggle:z,showAllLayers:f,buildingResults:N,streetResults:T,searchResults:_,panelCollapsed:g,onToggleCollapse:V,locationActive:b,onLocationToggle:G,isLocationTracking:w,locationError:S}),m.jsx(k,{buildings:n,streets:o,onRefresh:l}),m.jsx(R,{showCacheInfo:!0,cacheInfo:t}),m.jsx(P,{isVisible:s&&E.length>0,onClose:()=>i(!1)})]})},q=[-60.66904,-32.93968],K=()=>({updateMapHash:(e,t,a)=>{window.location.hash=((e,t,a)=>`#map=${e}/${t.toFixed(5)}/${a.toFixed(5)}`)(a,e,t)},getInitialMapState:()=>{if(!window.location.hash)return{zoom:12,center:q};return(e=>{if(!e.startsWith("#map="))return null;try{const t=e.replace("#map=","").split("/");if(3!==t.length)return null;const a=Number(t[0]),r=Number(t[1]),s=Number(t[2]);return!Number.isFinite(a)||a<1||a>20||!Number.isFinite(r)||r<-180||r>180||!Number.isFinite(s)||s<-90||s>90?null:{zoom:a,center:[r,s]}}catch(e){}return null})(window.location.hash)||{zoom:12,center:q}}});class X extends a.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){this.props.onError?.(e,t)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:m.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"white",padding:"20px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:9999,maxWidth:"400px",textAlign:"center"},children:[m.jsx("h2",{style:{color:"#dc2626",marginBottom:"12px"},children:"Algo saliÃ³ mal"}),m.jsx("p",{style:{color:"#6b7280",marginBottom:"16px"},children:"La aplicaciÃ³n encontrÃ³ un error inesperado. Por favor, recarga la pÃ¡gina."}),m.jsx("button",{onClick:()=>window.location.reload(),style:{backgroundColor:"#2563eb",color:"white",border:"none",padding:"8px 16px",borderRadius:"4px",cursor:"pointer"},children:"Recargar pÃ¡gina"})]}):this.props.children}}function J(){const{getInitialMapState:e}=K(),t=e(),{needRefresh:[r],updateServiceWorker:s}=function(e={}){const{immediate:t=!0,onNeedRefresh:r,onOfflineReady:s,onRegistered:n,onRegisteredSW:o,onRegisterError:l}=e,[c,d]=a.useState(!1),[u,h]=a.useState(!1),[p]=a.useState(()=>function(e={}){const{immediate:t=!1,onNeedRefresh:a,onOfflineReady:r,onRegistered:s,onRegisteredSW:n,onRegisterError:o}=e;let l,c,d;return c=async function(){if("serviceWorker"in navigator){if(l=await i(async()=>{const{Workbox:e}=await import("./workbox-window.prod.es5-Cd1IT8PJ.js");return{Workbox:e}},[]).then(({Workbox:e})=>new e("/mvp-mapa-sur/sw.js",{scope:"/mvp-mapa-sur/",type:"classic"})).catch(e=>{o?.(e)}),!l)return;d=async()=>{await(l?.messageSkipWaiting())};{let e=!1;const t=()=>{e=!0,l?.addEventListener("controlling",e=>{e.isUpdate&&window.location.reload()}),a?.()};l.addEventListener("installed",a=>{void 0===a.isUpdate?void 0!==a.isExternal?a.isExternal?t():!e&&r?.():a.isExternal?window.location.reload():!e&&r?.():a.isUpdate||r?.()}),l.addEventListener("waiting",t),l.addEventListener("externalwaiting",t)}l.register({immediate:t}).then(e=>{n?n("/mvp-mapa-sur/sw.js",e):s?.(e)}).catch(e=>{o?.(e)})}}(),async(e=!0)=>{await c,await(d?.())}}({immediate:t,onOfflineReady(){h(!0),s?.()},onNeedRefresh(){d(!0),r?.()},onRegistered:n,onRegisteredSW:o,onRegisterError:l}));return{needRefresh:[c,d],offlineReady:[u,h],updateServiceWorker:p}}();return m.jsxs(X,{children:[r&&m.jsxs("div",{className:"pwa-update-banner",children:[m.jsx("span",{children:"Â¡Nueva versiÃ³n disponible!"}),m.jsx("button",{onClick:()=>{s(!0)},children:"Actualizar y Recargar"})]}),m.jsx(S,{initialState:t,children:m.jsx(V,{})})]})}f.createRoot(document.getElementById("root")).render(m.jsx(s.StrictMode,{children:m.jsx(J,{})}));export{w as a,m as j,C as l,K as u};
