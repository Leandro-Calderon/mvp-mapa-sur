const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/maplibre-Crbi2ECN.js","assets/react-vendor-BYBhLt3k.js"])))=>i.map(i=>d[i]);
import{u as e,l as t,j as r,a as n}from"./index-gx9A_Wln.js";import{r as i}from"./react-vendor-BYBhLt3k.js";import{S as o,L as s,a as l,M as a,_ as c,u as p}from"./react-map-gl-vendor-Cqa43sAg.js";import{a as u}from"./maplibre-Crbi2ECN.js";const d=c(()=>import("./maplibre-Crbi2ECN.js").then(e=>e.m),__vite__mapDeps([0,1])),g=i.forwardRef(function(e,t){return a(e,t,d)}),m=l,f=s,y=o,h=()=>{const{current:r}=p(),{updateMapHash:n,getInitialMapState:o}=e(),s=i.useRef(!1),l=i.useRef(null),a=i.useRef(!1);return i.useEffect(()=>{if(!r)return;if(!s.current){const e=o();window.location.hash&&r.jumpTo({center:[e.center[0],e.center[1]],zoom:e.zoom}),s.current=!0}const e=()=>{l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{const e=r.getCenter(),i=r.getZoom();a.current=!0,n(e.lng,e.lat,Math.round(i)),t.debug("MapHashSync: Updated hash",{lng:e.lng,lat:e.lat,zoom:i}),setTimeout(()=>{a.current=!1},100)},300)};r.on("moveend",e);const i=()=>{if(a.current)return;const e=o();e&&r.flyTo({center:[e.center[0],e.center[1]],zoom:e.zoom,duration:1500})};return window.addEventListener("hashchange",i),()=>{r.off("moveend",e),window.removeEventListener("hashchange",i),l.current&&clearTimeout(l.current)}},[r,n,o]),null},x={liberty:{id:"liberty",name:"Claro",url:"/mvp-mapa-sur/styles/liberty.json"},dark:{id:"dark",name:"Oscuro",url:"/mvp-mapa-sur/styles/dark.json"},satellite:{id:"satellite",name:"SatÃ©lite",url:"/mvp-mapa-sur/styles/satellite.json"}},b=Object.values(x),j={liberty:"ðŸ—ºï¸",dark:"ðŸŒ™",satellite:"ðŸ›°ï¸"},S={liberty:"Default",dark:"Dark Mode",satellite:"SatÃ©lite"},v=i.memo(({currentStyle:e,onStyleChange:t})=>r.jsx("div",{className:"style-selector",style:{position:"absolute",bottom:"130px",right:"16px",zIndex:1e3,display:"flex",flexDirection:"column",gap:"8px"},children:b.map(n=>r.jsxs("button",{onClick:()=>{return e=n.id,void t(e);var e},style:{padding:"8px 12px",borderRadius:"8px",border:"none",backgroundColor:e===n.id?"#2563eb":"white",color:e===n.id?"white":"#1f2933",boxShadow:"0 2px 6px rgba(0,0,0,0.2)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"flex-start",gap:"8px",fontSize:"13px",fontWeight:500,transition:"all 0.2s",minWidth:"110px"},"aria-label":`Cambiar estilo a ${S[n.id]}`,children:[r.jsx("span",{style:{fontSize:"16px"},children:j[n.id]}),r.jsx("span",{children:S[n.id]})]},n.id))}));v.displayName="StyleSelector";const C={"line-color":"#00bcd4","line-width":5,"line-opacity":.9},w={"fill-color":"#3388ff","fill-opacity":.4,"fill-outline-color":"#0066cc"},k=i.memo(({filteredBuildings:e,filteredStreets:o,showAllLayers:s,userPosition:l,locationAccuracy:a,locationError:c,isLocationTracking:p,searchRevision:d,onMapClick:b})=>{const{mapState:j,setMapState:S,setMapReference:k}=n(),E=i.useRef(null),[M,L]=i.useState("liberty"),[z,T]=i.useState(null),B=i.useRef(0),F=i.useRef(null);i.useEffect(()=>{if(!l||!p)return void(p||(F.current=null));const e=`${l[0]},${l[1]}`;if(null===F.current){const e=E.current?.getMap();e&&e.flyTo({center:l,zoom:17,duration:2e3,essential:!0})}F.current=e},[l,p]);const R=i.useCallback(()=>{if(E.current){const e=E.current.getMap();k(e)}},[k]),D=i.useCallback(e=>{S({center:[e.viewState.longitude,e.viewState.latitude],zoom:e.viewState.zoom,bearing:e.viewState.bearing,pitch:e.viewState.pitch})},[S]),I=i.useCallback(async e=>{const r=e.features;if(!r||0===r.length)return T(null),void b?.();const n=r[0],i=n.layer?.id;if(t.debug("MapContainer: Feature clicked",{layerId:i,properties:n.properties}),"clusters"===i&&n.properties?.cluster){const e=E.current?.getMap();if(e){const r=n.properties.cluster_id,i=e.getSource("fonavi-buildings"),o=n.geometry.coordinates.slice();try{const t=await i.getClusterExpansionZoom(r);e.easeTo({center:o,zoom:t??14,duration:500})}catch(e){t.error("MapContainer: Error getting cluster expansion zoom",e)}}return}if("unclustered-point"===i){const e=n.geometry.coordinates.slice();return T({longitude:e[0],latitude:e[1],properties:n.properties??{},layerId:"unclustered-point"}),void t.debug("MapContainer: Building clicked",n.properties)}return"street-lines"===i||"street-fills"===i?(T({longitude:e.lngLat.lng,latitude:e.lngLat.lat,properties:n.properties??{},layerId:i}),void t.debug("MapContainer: Street clicked",n.properties)):void 0},[b]),_=i.useCallback(()=>{if(0===d||d===B.current)return;const r=e.length+o.length;if(0===r)return;B.current=d;const n=E.current?.getMap();if(!n)return;const i=new u.LngLatBounds;if(e.forEach(e=>{const[t,r]=e.geometry.coordinates;i.extend([t,r])}),o.forEach(e=>{const{type:t,coordinates:r}=e.geometry;"LineString"===t?r.forEach(([e,t])=>{i.extend([e,t])}):"MultiLineString"!==t&&"Polygon"!==t||r.forEach(e=>{e.forEach(([e,t])=>{i.extend([e,t])})})}),i.isEmpty())t.warn("MapContainer: Empty bounds, skipping navigation");else if(1===r){const e=i.getCenter();n.flyTo({center:e,zoom:17,duration:2e3,essential:!0})}else n.fitBounds(i,{padding:50,duration:2e3,essential:!0,maxZoom:17})},[e,o,d]);d!==B.current&&setTimeout(_,0);const P=i.useRef(s);i.useEffect(()=>{if(s&&!P.current){const t=E.current?.getMap();if(t&&e.length>0){const r=new u.LngLatBounds;e.forEach(e=>{const[t,n]=e.geometry.coordinates;r.extend([t,n])}),o.forEach(e=>{const{type:t,coordinates:n}=e.geometry;"LineString"===t?n.forEach(([e,t])=>r.extend([e,t])):"MultiLineString"!==t&&"Polygon"!==t||n.forEach(e=>{e.forEach(([e,t])=>r.extend([e,t]))})}),t.fitBounds(r,{padding:50,duration:2e3,essential:!0,maxZoom:14})}}P.current=s},[s,e,o]);const A={type:"FeatureCollection",features:e.map((e,t)=>({type:"Feature",id:t,geometry:e.geometry,properties:{...e.properties,_id:t}}))},N={type:"FeatureCollection",features:o.map((e,t)=>({type:"Feature",id:t,geometry:e.geometry,properties:{...e.properties,_id:t}}))},O=s||e.length>0,Z=s||o.length>0,$=l?{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:l},properties:{accuracy:a}}]}:null;return r.jsxs(g,{ref:E,initialViewState:{longitude:j.center[0],latitude:j.center[1],zoom:j.zoom,bearing:j.bearing??0,pitch:j.pitch??0},style:{width:"100%",height:"100%"},mapStyle:x[M].url,onLoad:R,onMove:D,onClick:I,interactiveLayerIds:["clusters","unclustered-point","street-lines","street-fills"],children:[r.jsx(h,{}),r.jsx(v,{currentStyle:M,onStyleChange:L}),O&&e.length>0&&r.jsx(y,{id:"fonavi-buildings",type:"geojson",data:A,children:r.jsx(f,{id:"unclustered-point",type:"circle",paint:{"circle-color":["match",["get","tipo"],"Bloque","#FF6B6B","Torre","#4ECDC4","Departamento","#45B7D1","#95A5A6"],"circle-radius":10,"circle-stroke-width":2,"circle-stroke-color":"#fff"}})}),Z&&o.length>0&&r.jsxs(y,{id:"streets",type:"geojson",data:N,children:[r.jsx(f,{id:"street-lines",type:"line",filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]],paint:C}),r.jsx(f,{id:"street-fills",type:"fill",filter:["==",["geometry-type"],"Polygon"],paint:w}),r.jsx(f,{id:"street-outlines",type:"line",filter:["==",["geometry-type"],"Polygon"],paint:{"line-color":"#0066cc","line-width":3}})]}),$&&p&&r.jsxs(y,{id:"user-location",type:"geojson",data:$,children:[a&&r.jsx(f,{id:"user-location-accuracy",type:"circle",paint:{"circle-radius":["/",a,2],"circle-color":"rgba(37, 99, 235, 0.15)","circle-stroke-color":"rgba(37, 99, 235, 0.3)","circle-stroke-width":1}}),r.jsx(f,{id:"user-location-dot",type:"circle",paint:{"circle-radius":8,"circle-color":"#2563eb","circle-stroke-width":3,"circle-stroke-color":"#fff"}})]}),z&&r.jsx(m,{longitude:z.longitude,latitude:z.latitude,anchor:"bottom",onClose:()=>T(null),closeOnClick:!1,children:r.jsx("div",{style:{padding:"8px",textAlign:"center"},children:"unclustered-point"===z.layerId?r.jsxs(r.Fragment,{children:[r.jsx("h4",{style:{margin:"0 0 8px 0",fontSize:"16px",color:"Bloque"===z.properties.tipo?"#FF6B6B":"Torre"===z.properties.tipo?"#4ECDC4":"#45B7D1"},children:String(z.properties.tipo)}),z.properties.nombre&&r.jsxs("p",{style:{margin:"4px 0",fontSize:"14px"},children:[r.jsx("strong",{children:"NÃºmero:"})," ",String(z.properties.nombre)]}),z.properties.plan&&r.jsxs("p",{style:{margin:"4px 0",fontSize:"14px"},children:[r.jsx("strong",{children:"Plan:"})," ",String(z.properties.plan)]})]}):r.jsxs(r.Fragment,{children:[r.jsx("strong",{children:String(z.properties.nombre)}),r.jsx("br",{}),"Tipo: ",String(z.properties.tipo)]})})})]})});k.displayName="MapContainer";export{k as MapContainer};
